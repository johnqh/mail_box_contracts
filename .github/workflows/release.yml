name: Build and Release to NPM

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [closed]  # Only when PR is merged
  workflow_dispatch:    # Allow manual triggering
    inputs:
      dry_run:
        description: 'Perform a dry run without publishing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write    # Allow creating tags and releases
  packages: write    # Allow publishing packages
  pull-requests: write  # Allow updating PRs

jobs:
  check-trigger:
    name: Check Release Trigger
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      new_version: ${{ steps.check.outputs.new_version }}
      version_tag: ${{ steps.check.outputs.version_tag }}
      trigger_reason: ${{ steps.check.outputs.trigger_reason }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Get current and previous commit
      
      - name: Check release trigger
        id: check
        run: |
          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual dispatch always proceeds
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "trigger_reason=Manual dispatch" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Manual dispatch - proceeding with version $CURRENT_VERSION"
            
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            # PR merged to main - always release
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "trigger_reason=PR merged to main" >> $GITHUB_OUTPUT
            echo "ðŸ”€ PR merged to main - proceeding with version $CURRENT_VERSION"
            
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Push to main - always release
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "trigger_reason=Push to main branch" >> $GITHUB_OUTPUT
            echo "ðŸ“¤ Push to main - proceeding with version $CURRENT_VERSION"
            
          else
            # Skip for other events
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "trigger_reason=Event not applicable for release" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping release for event: ${{ github.event_name }}"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for CI
        run: npm run build:ci
      
      - name: Run TypeScript tests
        run: npm run test:ci

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [check-trigger, test]
    if: needs.check-trigger.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level moderate || true
        continue-on-error: true
      
      - name: Check for high/critical vulnerabilities
        run: |
          echo "ðŸ” Checking for critical vulnerabilities..."
          npm audit --audit-level high || echo "âš ï¸ Known development-only vulnerabilities documented in SECURITY.md"
        continue-on-error: true

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [check-trigger, test, security-audit]
    if: needs.check-trigger.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build full package for release
        run: npm run build
      
      - name: Get current version
        id: version_bump
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "ðŸ“¦ Using version from package.json: $CURRENT_VERSION"

          # Set outputs using the existing version
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$CURRENT_VERSION" >> $GITHUB_OUTPUT

          echo "âœ… Publishing version $CURRENT_VERSION"
      
      - name: Set version info
        id: get_version
        run: |
          VERSION="${{ steps.version_bump.outputs.version_tag }}"
          VERSION_NUMBER="${{ steps.version_bump.outputs.new_version }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Publishing version: ${VERSION} (${VERSION_NUMBER})"
      
      - name: Verify build artifacts
        run: |
          echo "Checking dist directory..."
          ls -la dist/
          echo "Checking typechain-types directory..."
          ls -la typechain-types/
          echo "Verifying package.json main and types fields..."
          node -e "const pkg = require('./package.json'); console.log('Main:', pkg.main); console.log('Types:', pkg.types);"
      
      - name: Create .npmrc
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          echo "registry=https://registry.npmjs.org" >> .npmrc
          echo "access=public" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish to NPM
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª DRY RUN: Would publish to NPM"
            npm publish --dry-run --access public
          else
            echo "ðŸ“¦ Publishing to NPM"
            npm publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Verify NPM publication
        run: |
          PACKAGE_NAME=$(node -e "console.log(require('./package.json').name)")
          VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Published $PACKAGE_NAME@$VERSION"
          sleep 30  # Wait for npm registry to sync
          npm view $PACKAGE_NAME@$VERSION

  create-tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    needs: [check-trigger, test, security-audit, publish-npm]
    if: needs.check-trigger.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get published version
        id: get_published_version
        run: |
          # Use the version from package.json that was just published
          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "published_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Published version: $CURRENT_VERSION"
      
      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Configure git to use the GitHub token for authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          TAG="${{ steps.get_published_version.outputs.version_tag }}"
          echo "ðŸ·ï¸ Checking if tag exists: $TAG"
          
          # Check if tag already exists
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "âœ… Tag $TAG already exists - skipping creation"
          else
            echo "ðŸ·ï¸ Creating new tag: $TAG"
            git tag "$TAG" -m "Release $TAG - Published to NPM"
            git push origin "$TAG"
            echo "âœ… Tag $TAG created and pushed"
          fi

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-trigger, test, security-audit, create-tag, publish-npm]
    if: needs.check-trigger.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set version info
        id: get_version
        run: |
          # Use the version from package.json
          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          VERSION="v$CURRENT_VERSION"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Creating GitHub release for: $VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "## ðŸš€ Release ${{ steps.get_version.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "### ðŸ“‹ Changes since $LAST_TAG:" >> CHANGELOG.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges >> CHANGELOG.md
          else
            echo "### ðŸ“‹ Initial Release Changes:" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" --no-merges -10 >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "### ðŸ”§ Installation:" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "npm install @johnqh/mail_box_contracts@${{ steps.get_version.outputs.version }}" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          
          echo "" >> CHANGELOG.md
          echo "### ðŸ“¦ Package Info:" >> CHANGELOG.md
          echo "- **TypeScript Types**: Included" >> CHANGELOG.md
          echo "- **Contract ABIs**: Included in typechain-types" >> CHANGELOG.md
          echo "- **Solidity Version**: $(grep 'pragma solidity' contracts/*.sol | head -1 | cut -d' ' -f3 | tr -d ';')" >> CHANGELOG.md
          echo "- **Security Audited**: âœ…" >> CHANGELOG.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [check-trigger, publish-npm, create-github-release, create-tag]
    if: needs.check-trigger.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set version info
        id: get_version
        run: |
          # Use the version from package.json
          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          VERSION="v$CURRENT_VERSION"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Post-release tasks for: $VERSION"
      
      - name: Verify NPM package
        run: |
          PACKAGE_NAME="@johnqh/mail_box_contracts"
          sleep 60  # Wait for npm registry to fully sync
          
          echo "ðŸ” Verifying NPM package publication..."
          npm view $PACKAGE_NAME@${{ steps.get_version.outputs.version }} --json
          
          echo "ðŸ“¦ Package is available at:"
          echo "https://www.npmjs.com/package/$PACKAGE_NAME/v/${{ steps.get_version.outputs.version }}"
      
      
      - name: Create release summary
        run: |
          echo "## ðŸŽ‰ Release ${{ steps.get_version.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Package:" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM**: \`npm install @johnqh/mail_box_contracts@${{ steps.get_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM Package](https://www.npmjs.com/package/@johnqh/mail_box_contracts)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY